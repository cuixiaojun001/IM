<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>IMServer: Server端</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">IMServer<span id="projectnumber">&#160;1.0.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- 制作者 Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'搜索','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','搜索');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Server端 </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p ><a class="anchor" id="md_README"></a> </p>
<h1><a class="anchor" id="autotoc_md1"></a>
开发环境</h1>
<ul>
<li>Visual Studio 2022</li>
</ul>
<h1><a class="anchor" id="autotoc_md2"></a>
数据库设计</h1>
<ul>
<li>用户信息表(暂定TODO)</li>
</ul>
<div class="fragment"><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `t_user` (</div>
<div class="line">  `uuid` <span class="keywordtype">bigint</span>(<span class="stringliteral">20</span>) unsigned <span class="keyword">NOT</span> <span class="stringliteral">NULL</span> AUTO_INCREMENT,</div>
<div class="line">  `username` <span class="keywordtype">varchar</span>(<span class="stringliteral">255</span>) <span class="keyword">NOT</span> <span class="stringliteral">NULL</span>,</div>
<div class="line">  `password` <span class="keywordtype">varchar</span>(<span class="stringliteral">255</span>) <span class="keyword">NOT</span> <span class="stringliteral">NULL</span>,</div>
<div class="line">  `tel` <span class="keywordtype">varchar</span>(<span class="stringliteral">255</span>) <span class="keyword">DEFAULT</span> <span class="stringliteral">NULL</span>,</div>
<div class="line">  `icon` <span class="keywordtype">blob</span>,</div>
<div class="line">  `feeling` <span class="keywordtype">varchar</span>(<span class="stringliteral">255</span>) <span class="keyword">DEFAULT</span> <span class="stringliteral">NULL</span>,</div>
<div class="line">  <span class="keyword">PRIMARY</span> KEY (`uuid`)</div>
<div class="line">) ENGINE=InnoDB AUTO_INCREMENT=<span class="stringliteral">8</span> <span class="keyword">DEFAULT</span> CHARSET=utf8;</div>
</div><!-- fragment --><ul>
<li>好友关系表(暂定TODO)</li>
</ul>
<div class="fragment"><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `t_friendship` (</div>
<div class="line">  `uuid` <span class="keywordtype">bigint</span>(<span class="stringliteral">20</span>) unsigned <span class="keyword">NOT</span> <span class="stringliteral">NULL</span>,</div>
<div class="line">  `friend_id` <span class="keywordtype">bigint</span>(<span class="stringliteral">20</span>) unsigned <span class="keyword">NOT</span> <span class="stringliteral">NULL</span>,</div>
<div class="line">  KEY `uuid` (`uuid`),</div>
<div class="line">  KEY `t_friendship_ibfk_1` (`friend_id`),</div>
<div class="line">  <span class="keyword">CONSTRAINT</span> `t_friendship_ibfk_1` <span class="keyword">FOREIGN</span> KEY (`friend_id`) <span class="keyword">REFERENCES</span> `t_user` (`uuid`) <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE <span class="keyword">ON</span> <span class="keyword">UPDATE</span> CASCADE,</div>
<div class="line">  <span class="keyword">CONSTRAINT</span> `uuid` <span class="keyword">FOREIGN</span> KEY (`uuid`) <span class="keyword">REFERENCES</span> `t_user` (`uuid`) <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE <span class="keyword">ON</span> <span class="keyword">UPDATE</span> CASCADE</div>
<div class="line">) ENGINE=InnoDB <span class="keyword">DEFAULT</span> CHARSET=utf8;</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md3"></a>
自定义应用层协议</h1>
<h2><a class="anchor" id="autotoc_md4"></a>
协议头</h2>
<div class="fragment"><div class="line"><span class="comment">// 协议头</span></div>
<div class="line"><span class="preprocessor">#define _DEF_PROTOCOL_BASE (100)</span></div>
<div class="line"><span class="preprocessor">#define _DEF_PROTOCOL_COUNT (100)</span></div>
<div class="line"><span class="comment">// 注册</span></div>
<div class="line"><span class="preprocessor">#define _DEF_PACK_REGISTER_RQ   (_DEF_PROTOCOL_BASE + 0 )</span></div>
<div class="line"><span class="preprocessor">#define _DEF_PACK_REGISTER_RS   (_DEF_PROTOCOL_BASE + 1 )</span></div>
<div class="line"><span class="comment">//登录</span></div>
<div class="line"><span class="preprocessor">#define _DEF_PACK_LOGIN_RQ  (_DEF_PROTOCOL_BASE + 2 )</span></div>
<div class="line"><span class="preprocessor">#define _DEF_PACK_LOGIN_RS  (_DEF_PROTOCOL_BASE + 3 )</span></div>
<div class="line"><span class="comment">//好友信息</span></div>
<div class="line"><span class="preprocessor">#define _DEF_PACK_FRIEND_INFO   (_DEF_PROTOCOL_BASE + 4 )</span></div>
<div class="line"><span class="comment">//添加好友</span></div>
<div class="line"><span class="preprocessor">#define _DEF_PACK_ADDFRIEND_RQ  (_DEF_PROTOCOL_BASE + 5 )</span></div>
<div class="line"><span class="preprocessor">#define _DEF_PACK_ADDFRIEND_RS  (_DEF_PROTOCOL_BASE + 6 )</span></div>
<div class="line"><span class="comment">//聊天</span></div>
<div class="line"><span class="preprocessor">#define _DEF_PACK_CHAT_RQ   (_DEF_PROTOCOL_BASE + 7 )</span></div>
<div class="line"><span class="preprocessor">#define _DEF_PACK_CHAT_RS   (_DEF_PROTOCOL_BASE + 8 )</span></div>
<div class="line"><span class="comment">//离线</span></div>
<div class="line"><span class="preprocessor">#define _DEF_PACK_OFFLINE_RQ    (_DEF_PROTOCOL_BASE + 9 )</span></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md5"></a>
网络模块</h1>
<h2><a class="anchor" id="autotoc_md6"></a>
类图</h2>
<div class="fragment"><div class="line">classDiagram</div>
<div class="line">class INet {</div>
<div class="line">    &lt;&lt;Interface&gt;&gt;</div>
<div class="line">    + virtual bool InitNet()</div>
<div class="line">    + virtual void UnInitNet()</div>
<div class="line">    + virtual bool SendData(unsigned long lSendIP, const char* buf, int nLen)</div>
<div class="line">    # virtual void RecvData()</div>
<div class="line">}</div>
<div class="line">class TcpServer {</div>
<div class="line">    - SOCKET m_socket</div>
<div class="line">    - std::list~HANDLE~ m_hThreadHandleLst</div>
<div class="line">    - std::map~unsigned int, SOCKET~ m_mapThreadIdToSocket</div>
<div class="line">    - bool m_isStop</div>
<div class="line">    - static unsigned int __stdcall AcceptThread(LPVOID lpParameter)</div>
<div class="line">    - static unsigned int __stdcall RecvThread(LPVOID lpParameter)</div>
<div class="line">}</div>
<div class="line">class TcpClient {</div>
<div class="line">    - SOCKET m_socket</div>
<div class="line">    - HANDLE m_hThreadHandle</div>
<div class="line">    - bool m_isStop</div>
<div class="line">    - static unsigned int __stdcall RecvThread(LPVOID lpParameter)</div>
<div class="line">    </div>
<div class="line">}</div>
<div class="line">INet &lt;|.. TcpServer</div>
<div class="line"> </div>
<div class="line">INet &lt;|.. TcpClient</div>
<div class="line"> </div>
<div class="line">class INetMediator {</div>
<div class="line">    # INet* m_pNet</div>
<div class="line">    - virtual bool OpenNet()</div>
<div class="line">    - virtual void CloseNet()</div>
<div class="line">    - virtual bool SendData(unsigned long lSendIP, const char* buf, int nLen)</div>
<div class="line">    - virtual void DealData(unsigned long lSendIP, const char* buf, int nLen)</div>
<div class="line">}</div>
<div class="line">INetMediator &lt;|.. TcpServerMediator</div>
<div class="line">INetMediator &lt;|.. TcpClientMediator</div>
<div class="line"> </div>
<div class="line">INetMediator --&gt; INet</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md7"></a>
粘包问题</h2>
<ul>
<li>UDP是用户数据报协议, 在UDP协议中, 每个数据报都是不可拆分的, 发多少就接受多少, 接受不了的就直接扔掉</li>
<li>TCP是基于字节流的传输控制协议, 每个数据包是没有明显边界的, 一个数据包可以完整的发出, 也可以被分散到不同的数据包组合成一个包发出, 应用层需要解决粘包问题</li>
</ul>
<div class="fragment"><div class="line"><span class="keywordtype">bool</span> TcpServer::SendData(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> lSendIP, <span class="keyword">const</span> <span class="keywordtype">char</span>* buf, <span class="keywordtype">int</span> nLen)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (!buf || nLen &lt;= 0) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">        <span class="comment">// TODO: 防止粘包, 解决办法: 先发包大小, 再发数据包</span></div>
<div class="line">        send(lSendIP, (<span class="keywordtype">char</span>*)&amp;nLen, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), 0);</div>
<div class="line">        <span class="keywordflow">if</span> (send(lSendIP, buf, nLen, 0) &lt;= 0) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">    }</div>
<div class="line"><span class="keywordtype">void</span> TcpServer::RecvData()</div>
<div class="line">    {</div>
<div class="line">        Sleep(100);</div>
<div class="line">        SOCKET sockWaiter = m_mapThreadIdToSocket[GetCurrentThreadId()];</div>
<div class="line">        <span class="keywordflow">if</span> (!sockWaiter || sockWaiter == INVALID_SOCKET) <span class="keywordflow">return</span>;</div>
<div class="line">        <span class="keywordtype">int</span> nPackSize = 0; <span class="comment">// 存储包大小</span></div>
<div class="line">        </div>
<div class="line">        <span class="keywordtype">int</span> iResult = 0;</div>
<div class="line">        <span class="keywordflow">while</span> (!m_isStop) {</div>
<div class="line">            <span class="comment">// 先接受包大小 再接受数据包</span></div>
<div class="line">            iResult = recv(sockWaiter, (<span class="keywordtype">char</span>*)&amp;nPackSize, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), 0);</div>
<div class="line">            <span class="keywordflow">if</span> (iResult &lt;= 0) <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordtype">int</span> offset = 0; <span class="comment">//从buf开始起始偏移多少</span></div>
<div class="line">            <span class="keywordtype">char</span>* recvbuf = <span class="keyword">new</span> <span class="keywordtype">char</span>[nPackSize];</div>
<div class="line">            <span class="keywordflow">while</span> (nPackSize) {</div>
<div class="line">                <span class="keywordflow">if</span> ((iResult = recv(sockWaiter, recvbuf + offset, <span class="keyword">sizeof</span>(recvbuf), 0)) &gt; 0) {</div>
<div class="line">                    <span class="comment">// TODO: 处理数据</span></div>
<div class="line">                    nPackSize -= iResult;</div>
<div class="line">                    offset += iResult;</div>
<div class="line">                    sockaddr_in client_addr;</div>
<div class="line">                    <span class="keywordtype">int</span> addrSize = <span class="keyword">sizeof</span>(client_addr);</div>
<div class="line">                    getpeername(sockWaiter, (sockaddr*)&amp;client_addr, &amp;addrSize);</div>
<div class="line">                    std::cout &lt;&lt; <span class="stringliteral">&quot;ip[&quot;</span> &lt;&lt; inet_ntoa(client_addr.sin_addr) &lt;&lt; <span class="stringliteral">&quot;] says: &quot;</span> &lt;&lt; recvbuf &lt;&lt; std::endl;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            m_pMediator-&gt;DealData(sockWaiter, recvbuf, offset);</div>
<div class="line">        }</div>
<div class="line">    }</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md8"></a>
Kernel管理者(Singleton)</h1>
<div class="fragment"><div class="line">flowchart TD</div>
<div class="line">subgraph net</div>
<div class="line">    subgraph inet </div>
<div class="line">        TcpServer --&gt; INet</div>
<div class="line">        TcpClient --&gt;INet</div>
<div class="line">    end</div>
<div class="line">    </div>
<div class="line">    subgraph mediator</div>
<div class="line">        TcpServerMediator --&gt; INetMediator</div>
<div class="line">        TcpClientMediator --&gt; INetMediator</div>
<div class="line">    end</div>
<div class="line">    INetMediator --&gt; INet</div>
<div class="line">    INet --&gt; INetMediator</div>
<div class="line">end</div>
<div class="line">subgraph mysql</div>
<div class="line">CMySql</div>
<div class="line">end</div>
<div class="line">Kernel --&gt; CMySql</div>
<div class="line">Kernel --&gt; INetMediator</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md9"></a>
协议映射表</h2>
<blockquote class="doxtable">
<p >std::function()与std::bind()双剑合璧 </p>
</blockquote>
<ul>
<li>std::function() 一个可调用对象包装器。可以容纳除了类成员函数指针之外的所有可调用对象，它可以用统一的方式处理函数、函数对象、函数指针，并允许保存和延迟它们的执行。 std::function可以取代函数指针的作用，因为它可以延迟函数的执行，特别适合作为回调函数使用。它比普通函数指针更加的灵活和便利。</li>
<li><p class="startli">std::bind()</p>
<p class="startli">&gt; 类成员函数有一个默认的this参数, 所以类成员函数不能直接赋值给std::function.需要结合std::bind()使用.</p>
<p class="startli">可将std::bind()函数看作一个通用的函数适配器, 它接受一个可调用对象, 生成一个新的可调用对象来"适用"原对象的参数列表</p><ul>
<li>作用:<ol type="1">
<li>将可调用对象和其参数绑定成一个仿函数</li>
<li>只绑定部分参数，减少可调用对象传入的参数</li>
</ol>
</li>
</ul>
</li>
</ul>
<div class="fragment"><div class="line"><span class="keyword">static</span> std::map&lt;int, std::function&lt;void(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>, <span class="keyword">const</span> <span class="keywordtype">char</span>*, <span class="keywordtype">int</span>)&gt; &gt; m_deal_items;  </div>
<div class="line"><span class="preprocessor">#define XX(str, func) {\  </span></div>
<div class="line">    <span class="keyword">auto</span> call = std::bind(&amp;Kernel::func, <span class="keyword">this</span>, std::placeholders::_1, std::placeholders::_2, std::placeholders::_3); \  </div>
<div class="line">    m_deal_items.insert({ str, call });}  </div>
<div class="line">  </div>
<div class="line">    XX(_DEF_PACK_LOGIN_RQ, dealLoginRq);  </div>
<div class="line">    XX(_DEF_PACK_REGISTER_RQ, dealRegisterRq);  </div>
<div class="line">  </div>
<div class="line"><span class="preprocessor">#undef XX </span></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md10"></a>
Client端</h1>
<h2><a class="anchor" id="autotoc_md11"></a>
开发环境</h2>
<h2><a class="anchor" id="autotoc_md12"></a>
功能分析</h2>
<h3><a class="anchor" id="autotoc_md13"></a>
注册请求&amp;登录请求</h3>
<p ><img src="https://note.youdao.com/yws/res/2425/WEBRESOURCEd206aaec3b6b7a82a3aaa29fa67236f4" alt="image.png" class="inline"/></p>
<h3><a class="anchor" id="autotoc_md14"></a>
添加好友&amp;显示好友列表</h3>
<blockquote class="doxtable">
<p >QMenu类&amp;#x20;</p>
<p >用于菜单栏、上下文菜单和其他弹出菜单。 </p>
</blockquote>
<ul>
<li><p class="startli">动作：</p>
<p class="startli"><a href="https://doc.qt.io/qt-6/qwidget.html#addActions">addActions</a>（）--&gt;原型：void QWidget::addActions(const <a href="https://doc.qt.io/qt-6/qlist.html">QList</a>&lt;<a href="https://doc.qt.io/qt-6/qaction.html">QAction</a> *&gt; &amp;*actions*)</p>
<p class="startli">追加动作*actions*到此小部件的操作列表。</p>
</li>
<li>信号： <code>void QMenu::triggered(QAction *action)</code> 触发此菜单中的操作时会发出此信号。action是导致发出信号的动作。</li>
</ul>
<p ><img src="https://note.youdao.com/yws/res/2632/WEBRESOURCE40d3d54d5d5b3d867a7ab89303c38358" alt="添加好友&显示列表.png" class="inline"/></p>
<h3><a class="anchor" id="autotoc_md15"></a>
收发信息</h3>
<h3><a class="anchor" id="autotoc_md16"></a>
离线处理</h3>
<blockquote class="doxtable">
<p >窗口关闭事件（QCloseEvent）是当鼠标点击窗口右上角的关闭按钮时，所触发的函数。如果你没有重写virtual closeEvent(QCloseEvent*event);这个虚函数的话，系统是默认接受关闭事件的，所以就会关闭窗体。但有的时候，我们可能需要保存文本或做一些其他的处理，旧需要重写该函数，用来在窗口关闭之前处理自己需要的事情。 </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md17"></a>
Qt UI类</h2>
<h3><a class="anchor" id="autotoc_md18"></a>
QWidget</h3>
<blockquote class="doxtable">
<p >所有用户界面对象的基类 </p>
</blockquote>
<h3><a class="anchor" id="autotoc_md19"></a>
QDialog</h3>
<blockquote class="doxtable">
<p >对话框窗口的基类 </p>
</blockquote>
<ul>
<li>作用:主要用于短期任务以及和用户进行简要通讯的顶级窗口</li>
</ul>
<h4><a class="anchor" id="autotoc_md20"></a>
模态对话框</h4>
<ul>
<li>模态对话框，就是会阻塞同一应用程序中其它窗口的输入。</li>
</ul>
<h4><a class="anchor" id="autotoc_md21"></a>
非模态对话框</h4>
<ul>
<li>非模态对话框则在弹出后，可以继续操作主窗口。</li>
</ul>
<h3><a class="anchor" id="autotoc_md22"></a>
QMainWindow</h3>
<h1><a class="anchor" id="autotoc_md23"></a>
附加功能</h1>
<h2><a class="anchor" id="autotoc_md24"></a>
文件传输</h2>
<h3><a class="anchor" id="autotoc_md25"></a>
1. 发送文件流程</h3>
<ol type="1">
<li>发送文件头<ul>
<li>包括协议头, 文件唯一标识, 文件名和文件大小.<ul>
<li>协议头: 标识该数据包是干什么的</li>
<li>文件唯一标识: 区分不同文件的唯一标识<ul>
<li>方法：<ol type="a">
<li>MD5</li>
<li>文件名_时间(时间精确到毫秒)</li>
</ol>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>接收端返回确认信息<ul>
<li>包括协议头, 文件唯一标识和结果.<ul>
<li>文件唯一标识: 告诉对方这是对哪个文件的确认信息</li>
<li>结果: 同意接受或不同意</li>
</ul>
</li>
</ul>
</li>
<li>发送文件块<ul>
<li>包括协议头, 文件唯一标识, 文件内容和发送的长度<ul>
<li>文件唯一标识: 标识发送的是哪一个文件</li>
<li>发送的长度: 标识此次发送的长度(发送缓冲区默认大小是64K)</li>
</ul>
</li>
</ul>
</li>
<li>文件读取结束<ul>
<li>写入的文件大小等于文件实际大小, 结束接受和发送</li>
</ul>
</li>
</ol>
<h3><a class="anchor" id="autotoc_md26"></a>
2. 定义文件传输协议</h3>
<h4><a class="anchor" id="autotoc_md27"></a>
协议头</h4>
<p ><img src="https://note.youdao.com/yws/res/2484/WEBRESOURCE063e3123b39f8aee1f1dc4568c5a5ee4" alt="image.png" class="inline"/></p>
<h4><a class="anchor" id="autotoc_md28"></a>
定义协议结构</h4>
<ol type="1">
<li>文件信息请求</li>
<li>文件信息回复</li>
<li>文件块请求</li>
<li>文件块接受回复</li>
<li>文件信息</li>
</ol>
<h3><a class="anchor" id="autotoc_md29"></a>
3. 发送文件流程</h3>
<ol type="1">
<li>获取文件信息</li>
</ol>
<blockquote class="doxtable">
<p >创建一个 “打开 ”对话框，允许用户指定要打开的文件或文件集的名称、目录和名称。 BOOL GetOpenFileNameA( [in, out] LPOPENFILENAMEA unnamedParam1 ); 返回值： 类型: BOOL 如果用户指定文件名并单击“ 确定 ”按钮，则返回值为非零。 OPENFILENAME 结构的 lpstrFile 成员指向的缓冲区包含用户指定的完整路径和文件名。 如果用户取消或关闭 “打开 ”对话框或发生错误，则返回值为零。 typedef struct tagOFNA { // OPENFILENAME 结构体 DWORD lStructSize; // 结构体长度 HWND hwndOwner; // 当前窗口的父窗口, 0 居中显示 ...... LPCSTR lpstrFilter; // 过滤器, 显示的文件的类型 ...... LPSTR lpstrFile; // 指向一块缓冲区, 存放被选择文件的完整路径 DWORD nMaxFile; // lpstrFile 指向的缓冲区的大小 ...... DWORD Flags; // 一组可用于初始化对话框的位标志 ...... } OPENFILENAMEA, *LPOPENFILENAMEA; </p>
</blockquote>
<ol type="1">
<li>发送文件信息请求</li>
<li>从文件路径中获取文件名</li>
<li>发送消息块</li>
</ol>
<h3><a class="anchor" id="autotoc_md30"></a>
4. 接受文件流程</h3>
<ol type="1">
<li>处理文件信息请求</li>
</ol>
<blockquote class="doxtable">
<p >创建“ 保存 ”对话框，允许用户指定要保存的文件的驱动器、目录和名称。 BOOL GetSaveFileNameA( [in, out] LPOPENFILENAMEA unnamedParam1 ); <code>void <a class="el" href="d1/db8/classKernel.html#a6f2e1f9ad7f235aa62a7173af96d7175" title="处理文件传输信息请求">Kernel::DealFileInfoRq(unsigned long lSendIP, const char* buf, int nLen)</a>;</code> </p>
</blockquote>
<ol type="1">
<li>处理文件块请求 <code>void <a class="el" href="d1/db8/classKernel.html#aa9259e7ab3d47dd07a47e9d1c3596f7b" title="处理文件块请求">Kernel::DealFileBlockRq(unsigned long lSendIP, const char* buf, int nLen)</a>;</code></li>
</ol>
<h2><a class="anchor" id="autotoc_md31"></a>
Qt客户端&lt;QFileDialog&gt;API打开文件对话框</h2>
<ul>
<li>getOpenFileName返回一个被用户选中的文件的路径，前提是这个文件是存在的。</li>
<li>getSaveFileName返回一个被用户选中的文件的路径，这个文件可以是不存在的。</li>
<li>getOpenFileNames返回一个或多个被用户选中的文件的路径，前提是这些文件是存在的。</li>
</ul>
<h2><a class="anchor" id="autotoc_md32"></a>
客户端移植到Qt</h2>
<h3><a class="anchor" id="autotoc_md33"></a>
Qt客户端&lt;QFileDialog&gt;API打开文件对话框</h3>
<ul>
<li>getOpenFileName返回一个被用户选中的文件的路径，前提是这个文件是存在的。</li>
<li>getSaveFileName返回一个被用户选中的文件的路径，这个文件可以是不存在的。</li>
<li>getOpenFileNames返回一个或多个被用户选中的文件的路径，前提是这些文件是存在的。</li>
</ul>
<h3><a class="anchor" id="autotoc_md34"></a>
客户端处理流程</h3>
<p ><img src="https://note.youdao.com/yws/res/2603/WEBRESOURCE16b831dda70bcfd094624fe838e2936c" alt="文件传输.png" class="inline"/></p>
<h3><a class="anchor" id="autotoc_md35"></a>
优化TODO</h3>
<ul>
<li>如果好友在同意接受后突然下线, 需要保存断点</li>
</ul>
<p ><img src="https://note.youdao.com/yws/res/2622/WEBRESOURCE0be77d99a75a1d32c5f70df218c0639c" alt="image.png" class="inline"/></p>
<p >添加好友字符集 </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">制作者 <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2 </li>
  </ul>
</div>
</body>
</html>
